# Toast 보안 가이드

이 문서는 Toast 앱의 보안 모델, 데이터 보호 방법, 인증 시스템을 설명합니다.

## 목차

- [개요](#개요)
- [인증 시스템](#인증-시스템)
  - [OAuth 인증 흐름](#oauth-인증-흐름)
  - [토큰 관리](#토큰-관리)
  - [세션 처리](#세션-처리)
- [데이터 보호](#데이터-보호)
  - [저장 데이터 보호](#저장-데이터-보호)
  - [전송 중 데이터 보호](#전송-중-데이터-보호)
  - [로컬 스토리지](#로컬-스토리지)
- [권한 관리](#권한-관리)
  - [사용자 권한 수준](#사용자-권한-수준)
  - [기능 액세스 제어](#기능-액세스-제어)
- [스크립트 보안](#스크립트-보안)
  - [사용자 정의 스크립트 샌드박싱](#사용자-정의-스크립트-샌드박싱)
  - [스크립트 실행 제한](#스크립트-실행-제한)
- [네트워크 보안](#네트워크-보안)
  - [API 통신](#api-통신)
  - [인증서 검증](#인증서-검증)
- [운영체제 통합](#운영체제-통합)
  - [macOS 보안 통합](#macos-보안-통합)
  - [Windows 보안 통합](#windows-보안-통합)
- [보안 모범 사례](#보안-모범-사례)
- [보안 취약점 보고](#보안-취약점-보고)
- [관련 문서](#관련-문서)

## 개요

Toast 앱은 민감한 사용자 데이터(인증 토큰, 사용자 프로필, 버튼 구성 등)를 처리합니다. 이 문서에서는 이러한 데이터를 보호하고 안전한 사용자 경험을 제공하기 위해 구현된 보안 조치를 설명합니다.

## 인증 시스템

Toast 앱은 OAuth 2.0 프로토콜을 사용하여 안전한 사용자 인증을 제공합니다. 상세한 인증 흐름과 API 연동에 대해서는 [DEV_INTEGRATION.md](./DEV_INTEGRATION.md) 문서를 참조하세요.

### OAuth 인증 흐름

인증 흐름은 다음 단계로 구성됩니다:

1. **인증 시작**:
   - 사용자가 설정에서 '로그인' 버튼을 클릭합니다.
   - 앱이 시스템 브라우저를 열어 Toast 웹 서비스 인증 페이지로 리디렉션합니다.
   - 브라우저에서 PKCE(Proof Key for Code Exchange) 확장을 사용하여 인증 요청이 생성됩니다.

2. **사용자 인증**:
   - 사용자가 Toast 웹 서비스에서 로그인합니다.
   - 인증 성공 후, 서비스는 사용자를 사용자 정의 프로토콜 URI(`toast-app://auth`)로 리디렉션합니다.
   - 리디렉션 URI에는 일회용 인증 코드가 포함됩니다.

3. **토큰 교환**:
   - 앱은 사용자 정의 프로토콜 핸들러를 통해 인증 코드를 가로챕니다.
   - 앱은 인증 코드와 원래 PKCE verifier를 사용하여 액세스 토큰 및 새로고침 토큰을 요청합니다.
   - 토큰은 안전하게 저장됩니다(아래 '토큰 관리' 참조).

4. **프로필 검색**:
   - 토큰이 저장되면 앱은 토큰을 사용하여 사용자 프로필 및 구독 정보를 가져옵니다.
   - 이 정보는 앱 전체에 동기화됩니다.

### 토큰 관리

인증 토큰은 다음과 같이 관리됩니다:

1. **토큰 암호화**: 모든 토큰은 운영 체제의 보안 메커니즘을 사용하여 암호화됩니다:
   - macOS: Keychain
   - Windows: Data Protection API (DPAPI)
   - Linux: libsecret

2. **메모리 내 토큰 처리**:
   - 토큰은 필요한 경우에만 메모리에 유지됩니다.
   - 메모리에 있는 동안 민감한 데이터는 민감한 메모리 버퍼에 저장됩니다.
   - 사용 후 메모리는 의도적으로 제거됩니다.

3. **토큰 만료 정책**:
   - 액세스 토큰은 무기한으로 설정되어 동기화 중단을 방지합니다(기본 1년, 환경 설정으로 무기한 가능).
   - 리프레시 토큰은 매우 긴 시간(10년)으로 설정되어 실질적으로 무기한입니다.
   - 이러한 설정은 클라우드 동기화의 안정성을 보장하기 위한 것입니다.
   - 토큰 갱신은 필요에 따라 자동으로 수행되며, 사용자가 여러 기기에서 동시에 로그인한 상태를 유지할 수 있도록 조정됩니다.

4. **로그아웃 처리**:
   - 로그아웃 시 모든 로컬 토큰이 안전하게 제거됩니다.
   - 또한 서버 측에서 토큰이 취소되어 더 이상 사용할 수 없습니다.

### 세션 처리

사용자 세션은 다음과 같이 관리됩니다:

1. **세션 유효성**: 세션 상태는 토큰 유효성 규칙에 따라 추적됩니다.
2. **자동 재인증**: 세션이 만료되면 앱이 자동으로 새로고침을 시도합니다.
3. **세션 동기화**: 세션 상태는 앱의 모든 창과 프로세스에 동기화됩니다.
4. **로컬 세션 종료**: 연결 문제 또는 새로고침 토큰 만료로 인해 로컬 세션이 종료될 수 있습니다.

## 데이터 보호

### 저장 데이터 보호

1. **구성 데이터**:
   - 구성 파일은 JSON 형식으로 저장되며 민감한 정보를 포함하지 않습니다.
   - 중요한 인증 및 구독 정보는 별도의 암호화된 스토리지에 보관됩니다.

2. **인증 토큰**:
   - 토큰은 앞서 설명한 대로 암호화되어 저장됩니다.
   - 토큰 파일은 ACL(액세스 제어 목록)을 통해 승인된 사용자만 접근할 수 있습니다.

3. **사용자 프로필 데이터**:
   - 개인 식별 정보는 최소한으로 유지됩니다(일반적으로 이메일 주소만).
   - 프로필 데이터는 토큰 스토리지와 동일한 보안 표준을 사용하여 저장됩니다.

4. **스크립트 데이터**:
   - 사용자 정의 스크립트는 일반 텍스트로 저장됩니다.
   - 사용자는 스크립트 내용에 민감한 정보를 포함하지 않도록 주의해야 합니다.

### 전송 중 데이터 보호

1. **API 통신**:
   - 모든 API 통신은 TLS 1.2 이상을 통해 수행됩니다.
   - 인증서 핀닝은 MITM(중간자) 공격 방지를 위해 사용됩니다.
   - 민감한 요청 및 응답에 추가 암호화 레이어가 적용됩니다.

2. **데이터 최소화**:
   - API 요청 및 응답은 필요한 데이터만 포함하도록 최소화됩니다.
   - 민감한 데이터는 필요할 때만 전송됩니다.

### 로컬 스토리지

1. **데이터 분리**:
   - 서로 다른 유형의 데이터는 분리된 위치에 저장됩니다.
   - 이렇게 하면 한 종류의 데이터가 손상되어도 다른 데이터는 보호됩니다.

2. **권한 관리**:
   - 데이터 파일은 최소 권한 원칙을 따릅니다.
   - 파일 시스템 권한은 현재 사용자만 액세스할 수 있도록 설정됩니다.

3. **안전한 데이터 제거**:
   - 앱 제거 시 민감한 데이터가 완전히 삭제됩니다.
   - 로그아웃 시 모든 인증 관련 데이터가 안전하게 제거됩니다.

## 권한 관리

### 사용자 권한 수준

Toast 앱은 다음과 같은 사용자 권한 수준을 정의합니다:

1. **익명 사용자**:
   - 로그인하지 않은 사용자입니다.
   - 기본 기능에만 액세스할 수 있습니다(1개 페이지로 제한).
   - 클라우드 동기화 또는 고급 기능에 액세스할 수 없습니다.

2. **인증된 기본 사용자**:
   - 로그인한 무료 계정 사용자입니다.
   - 최대 3개 페이지에 액세스할 수 있습니다.
   - 제한된 클라우드 동기화 기능이 있습니다.

3. **프리미엄 사용자**:
   - 로그인하고 유효한 프리미엄 구독이 있는 사용자입니다.
   - 최대 9개 페이지에 액세스할 수 있습니다.
   - 모든 기능에 액세스할 수 있습니다.

### 기능 액세스 제어

1. **구독 확인**:
   - 보호된 기능은 사용 전에 사용자의 구독 수준을 확인합니다.
   - 구독 상태는 로컬에 캐시되지만 정기적으로 서버와 동기화됩니다.

2. **단계적 실패**:
   - 구독 확인이 실패하면 기능이 제한된 모드로 작동합니다.
   - 네트워크 연결이 불안정한 경우 사용자 경험을 보존하기 위해 일시적으로 기능이 허용될 수 있습니다.

## 스크립트 보안

### 사용자 정의 스크립트 샌드박싱

Toast 앱은 스크립트 실행을 위한 샌드박스 환경을 제공합니다:

1. **JavaScript 샌드박스**:
   - 사용자 정의 JavaScript는 제한된 컨텍스트에서 실행됩니다.
   - 이 환경은 다음과 같은 제한이 있습니다:
     - 파일 시스템 액세스 없음.
     - 제한된 네트워크 액세스(허용된 API 엔드포인트만).
     - DOM 액세스 없음.
     - 제한된 실행 시간(기본 10초 제한).
     - 제한된 메모리 사용.

2. **셸 스크립트 보안**:
   - 셸 스크립트(Bash, PowerShell 등) 실행은 프리미엄 사용자만 가능합니다.
   - 셸 스크립트는 잠재적인 위험에 대한 경고와 함께 실행됩니다.
   - 실행은 현재 사용자의 권한으로 제한됩니다.

### 스크립트 실행 제한

1. **API 액세스 제어**:
   - 스크립트는 제한된 API 집합에만 액세스할 수 있습니다.
   - 민감한 API는 화이트리스트 방식으로 노출됩니다.

2. **자원 제한**:
   - CPU 사용량, 메모리 사용량, 실행 시간에 대한 제한이 적용됩니다.
   - 이러한 제한을 초과하는 스크립트는 자동으로 종료됩니다.

3. **오류 처리**:
   - 스크립트 오류는 사용자 환경에 영향을 미치지 않도록 격리됩니다.
   - 충돌이 발생한 스크립트는 다음 실행 전에 사용자 승인이 필요합니다.

## 네트워크 보안

### API 통신

1. **인증 헤더**:
   - API 요청에는 Bearer 토큰 인증이 필요합니다.
   - 민감한 엔드포인트에는 추가 인증 검사가 필요합니다.

2. **요청 제한**:
   - API 요청은 속도 제한이 적용됩니다.
   - 과도한 요청은 지수 백오프로 처리됩니다.

3. **데이터 유효성 검사**:
   - 모든 API 응답 데이터는 처리 전에 검증됩니다.
   - 잘못된 데이터는 자동으로 거부됩니다.

### 인증서 검증

1. **인증서 핀닝**:
   - 알려진 서버 인증서의 지문을 확인하여 MITM 공격을 방지합니다.
   - 인증서 불일치는 연결 거부로 이어집니다.

2. **인증서 투명성**:
   - Certificate Transparency 로그를 확인하여 인증서 유효성을 검증합니다.

## 운영체제 통합

### macOS 보안 통합

1. **App Sandbox**:
   - macOS 앱은 샌드박스로 실행되어 시스템 리소스에 대한 액세스를 제한합니다.
   - 필요한 권한은 entitlements.mac.plist 파일에 명시적으로 선언됩니다.

2. **Hardened Runtime**:
   - macOS 앱은 강화된 런타임을 사용하여 코드 무결성 보호를 제공합니다.
   - 런타임 메모리 안전성 기능이 활성화되어 있습니다.

3. **Keychain 통합**:
   - 인증 토큰은 macOS Keychain에 저장되어 하드웨어 수준의 보안을 제공합니다.

### Windows 보안 통합

1. **DPAPI 보호**:
   - Windows 앱은 DPAPI(Data Protection API)를 사용하여 민감한 데이터를 암호화합니다.
   - 이는 Windows 사용자 계정에 연결된 키로 데이터를 보호합니다.

2. **권한 격리**:
   - 앱은 최소 권한으로 실행됩니다.
   - UAC(User Account Control) 승격은 필요한 경우에만 요청됩니다.

## 보안 모범 사례

사용자가 Toast 앱을 안전하게 사용하기 위한 권장 사항:

1. **항상 최신 버전 유지**:
   - 보안 패치와 개선 사항이 포함된 최신 버전을 유지하세요.
   - 자동 업데이트 기능을 활성화하세요.

2. **강력한 계정 보안**:
   - Toast 계정에 강력하고 고유한 암호를 사용하세요.
   - 가능하면 2단계 인증을 활성화하세요.

3. **스크립트 주의사항**:
   - 신뢰할 수 있는 출처의 스크립트만 실행하세요.
   - 스크립트를 실행하기 전에 검토하세요.
   - 스크립트에 민감한 정보를 포함하지 마세요.

4. **공유 컴퓨터 사용**:
   - 공유 컴퓨터에서 사용 후 항상 로그아웃하세요.
   - 자동 로그인 기능을 사용하지 마세요.

5. **정기적인 구성 백업**:
   - 구성을 정기적으로 안전한 위치에 백업하세요.
   - 백업 파일을 안전하게 저장하세요.

## 보안 취약점 보고

Toast 앱에서 보안 취약점을 발견한 경우:

1. **책임 있는 공개**:
   - 취약점 세부 정보를 공개적으로 공유하지 마세요.
   - [security@toast-app.example.com](mailto:security@toast-app.example.com)으로 취약점을 보고하세요.

2. **보고 가이드라인**:
   - 명확한 취약점 설명을 제공하세요.
   - 가능한 경우 취약점을 재현하는 단계를 포함하세요.
   - 잠재적 영향 범위를 설명하세요.
   - 선택적으로 완화 또는 수정 제안을 제공하세요.

3. **보안 보고서 처리**:
   - 모든 보고서는 48시간 이내에 확인됩니다.
   - 심각도와 복잡성에 따라 해결 시간이 달라집니다.
   - 취약점을 신고한 분에게는 해결 과정에 대한 정기적인 업데이트가 제공됩니다.

## 관련 문서

- **인증 시스템 전체 개요**: [DEV_INTEGRATION.md](./DEV_INTEGRATION.md)
- **클라우드 동기화 구현**: [FEATURE_CLOUD_SYNC.md](./FEATURE_CLOUD_SYNC.md)
- **API 문서**: [API_DOCUMENTATION.md](./API_DOCUMENTATION.md)
