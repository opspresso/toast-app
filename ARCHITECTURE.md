# Toast 앱 아키텍처

이 문서는 Toast 앱의 고수준 아키텍처를 설명하며, 컴포넌트, 데이터 흐름 및 설계 결정을 포함합니다.

## 개요

Toast 앱은 macOS 및 Windows용 사용자 정의 단축키 실행기를 제공하는 Electron 기반 데스크톱 애플리케이션입니다. 이 애플리케이션은 메인 프로세스와 렌더러 프로세스 간의 명확한 관심사 분리와 함께 모듈식 아키텍처를 따릅니다.

## 시스템 아키텍처

### 고수준 컴포넌트

```
┌─────────────────────────────────────────────────────────────┐
│                        Toast App                            │
│                                                             │
│  ┌─────────────┐          ┌─────────────┐                   │
│  │             │          │             │                   │
│  │ Main Process │◄────────►│  Renderer   │                   │
│  │             │   IPC    │  Processes  │                   │
│  │             │          │             │                   │
│  └─────┬───────┘          └─────────────┘                   │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │             │                                            │
│  │   Native    │                                            │
│  │   System    │                                            │
│  │             │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 메인 프로세스

메인 프로세스는 다음을 담당합니다:

1. 애플리케이션 수명 주기 관리
2. 윈도우 관리
3. 시스템 트레이 통합
4. 전역 단축키 등록
5. 구성 관리
6. 액션 실행
7. 프로세스 간 통신(IPC)

### 렌더러 프로세스

Toast 앱에는 두 가지 주요 렌더러 프로세스가 있습니다:

1. **Toast 윈도우**: 버튼을 표시하고 액션을 실행하는 팝업 윈도우
2. **설정 윈도우**: 애플리케이션을 구성하기 위한 윈도우

각 렌더러 프로세스는 자체 HTML, CSS 및 JavaScript 파일을 가지며, IPC를 통해 메인 프로세스와 통신합니다.

## 컴포넌트 아키텍처

### 메인 프로세스 컴포넌트

```
┌─────────────────────────────────────────────────────────────┐
│                      Main Process                           │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │   Config    │    │   Windows   │    │    Tray     │      │
│  │   Manager   │    │   Manager   │    │   Manager   │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │  Shortcuts  │    │     IPC     │    │   Executor  │      │
│  │   Manager   │    │   Handler   │    │             │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │    Auth     │    │   Cloud     │    │   Actions   │      │
│  │   Manager   │    │    Sync     │    │             │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

#### 구성 관리자 (`src/main/config.js`)

electron-store를 사용하여 구성 저장, 유효성 검사 및 마이그레이션을 처리합니다.

**책임:**
- 구성 저장 및 검색
- 스키마에 대한 구성 유효성 검사
- 기본값 제공
- 구성 마이그레이션 처리
- 구성 가져오기/내보내기

**구성 스키마:**
- **globalHotkey**: Toast 팝업을 트리거하는 전역 키보드 단축키
- **pages**: 버튼을 포함하는 페이지 구성 배열
- **appearance**: 시각적 외관 설정(테마, 위치, 크기, 불투명도, 버튼 레이아웃)
- **advanced**: 고급 동작 설정(시작 시 실행, 액션 후 숨기기 등)
- **subscription**: 구독 상태 및 기능
- **firstLaunchCompleted**: 첫 실행 설정이 완료되었는지 여부를 나타내는 플래그

#### 윈도우 관리자 (`src/main/windows.js`)

애플리케이션 윈도우의 생성, 위치 지정 및 수명 주기를 관리합니다.

**책임:**
- Toast 및 설정 윈도우 생성
- 구성에 따른 윈도우 위치 지정
- 윈도우 표시 및 숨기기
- 윈도우 이벤트 처리
- 렌더러 프로세스에 구성 전송

#### 트레이 관리자 (`src/main/tray.js`)

시스템 트레이 아이콘과 메뉴를 관리합니다.

**책임:**
- 트레이 아이콘 생성 및 업데이트
- 트레이 컨텍스트 메뉴 구성
- 트레이 이벤트 처리

#### 단축키 관리자 (`src/main/shortcuts.js`)

전역 키보드 단축키를 관리합니다.

**책임:**
- 전역 단축키 등록 및 해제
- 단축키 이벤트 처리
- 구성에 따른 Toast 윈도우 위치 지정(중앙, 상단, 하단, 커서)
- Toast 윈도우 가시성 전환

#### IPC 핸들러 (`src/main/ipc.js`)

메인 프로세스와 렌더러 프로세스 간의 프로세스 간 통신을 처리합니다.

**책임:**
- IPC 채널 설정
- IPC 메시지 처리
- 실행기에 액션 전달
- 렌더러에 구성 업데이트 전송
- 렌더러 프로세스가 구성을 조작하기 위한 메서드 제공
- 키보드 단축키 녹화 처리

#### 실행기 (`src/main/executor.js`)

액션 유형에 따라 액션을 실행합니다.

**책임:**
- 액션 유효성 검사
- 액션 실행
- 액션 결과 처리
- 특정 액션 핸들러에 액션 전달
- 체인 액션을 순차적으로 실행

#### 액션 (`src/main/actions/*.js`)

특정 액션 유형을 구현합니다.

**책임:**
- 특정 액션 유형 실행(애플리케이션, 실행, 열기, 단축키, 스크립트, 체인)
- 액션별 매개변수 처리
- 표준화된 결과 반환
- 플랫폼별 동작 처리

#### 인증 시스템 (`src/main/auth-manager.js` 및 `src/main/auth.js`)

인증 시스템은 Toast 웹 서비스와의 사용자 인증을 관리하고 여러 통합 컴포넌트를 통해 구독 상태를 처리합니다:

```
┌──────────────────────────────────────────────────────────────┐
│                   Authentication System                      │
│                                                              │
│  ┌────────────────┐      ┌────────────────┐                  │
│  │                │      │                │                  │
│  │  Auth Manager  │◄────►│  Auth Module   │                  │
│  │                │      │                │                  │
│  └───────┬────────┘      └────────┬───────┘                  │
│          │                        │                          │
│          ▼                        ▼                          │
│  ┌────────────────┐      ┌────────────────┐                  │
│  │                │      │                │                  │
│  │   User Data    │      │  API Client    │                  │
│  │    Manager     │      │                │                  │
│  │                │      │                │                  │
│  └────────────────┘      └────────────────┘                  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**인증 컴포넌트:**

1. **인증 관리자 (`auth-manager.js`)**: 인증 작업의 중앙 코디네이터
   - 창 간에 인증 상태 동기화
   - 로그인/로그아웃 프로세스 관리
   - 토큰 새로고침 조정
   - UI 컴포넌트에 인증 상태 변경 알림
   - 인증 흐름 중 창 작업 방지

2. **인증 모듈 (`auth.js`)**: 핵심 인증 구현
   - OAuth 2.0 인증 흐름 구현
   - 원자적 저장소를 사용하여 토큰 안전하게 관리
   - 토큰 유효성 검사 및 새로고침 처리
   - 구독 수준 및 권한 관리
   - OAuth 리디렉션을 위한 프로토콜 핸들러 구현

3. **사용자 데이터 관리자**: 사용자 프로필 및 설정 데이터 관리
   - 프로필 및 구독 정보 유지
   - 사용자 설정 동기화 처리
   - 사용자 데이터에 대한 캐시된 액세스 제공
   - 로그아웃 시 사용자 데이터 정리 관리

4. **API 클라이언트**: 낮은 수준의 API 통신
   - 인증을 통한 API 요청 처리
   - 자동 토큰 새로고침 관리
   - 재시도 로직 및 오류 처리 구현
   - 표준화된 API 응답 형식 제공

**인증 흐름:**

1. **로그인 시작:**
   - 사용자가 설정 창에서 로그인 버튼 클릭
   - 시스템이 보안을 위한 클라이언트 ID 및 상태 매개변수가 있는 OAuth 2.0 인증 URL 생성
   - 인증을 위해 외부 시스템 브라우저 열림(앱과의 분리 유지)
   - 사용자가 사용자명/비밀번호 또는 SSO로 Toast 웹 서비스에 인증
   - 인증 서버가 자격 증명을 확인하고 요청된 범위에 대한 사용자 동의 획득

2. **토큰 처리:**
   - 브라우저가 인증 코드가 있는 사용자 정의 프로토콜 핸들러(toast-app://)로 리디렉션
   - 앱이 CSRF 공격을 방지하기 위해 상태 매개변수 검증
   - 앱이 URL 매개변수에서 인증 코드 캡처
   - 코드는 보안 백엔드 채널을 통해 액세스 및 새로고침 토큰으로 교환
   - 토큰은 원자적 파일 작업을 사용하여 안전하게 저장됨:
     ```
     1. 임시 파일에 쓰기
     2. 쓰여진 콘텐츠 검증
     3. 대상 파일로 원자적으로 이름 변경
     4. 플랫폼별 동작 처리(Windows는 연결 해제 필요)
     ```

3. **토큰 관리:**
   - 액세스 토큰은 1시간 후 만료(환경 변수를 통해 구성 가능)
   - 시스템은 만료 접근 시 사전에 토큰 갱신(30초 안전 여유)
   - 과도한 새로고침 시도 방지를 위한 새로고침 스로틀링 메커니즘:
     ```
     1. 마지막 새로고침 타임스탬프 추적
     2. 냉각 기간 시행(새로고침 간 5분)
     3. 동시 요청 간에 새로고침 약속 공유
     4. 연속 새로고침 실패 카운트
     ```
   - 반복된 실패 후 점진적 잠금(최대 3회 새로고침 시도)
   - 안전한 파일 지속성이 있는 메모리 기반 토큰 캐시

4. **구독 처리:**
   - 시스템이 프로필 엔드포인트에서 구독 정보 가져오기 및 구문 분석
   - 호환성을 위한 다양한 응답 형식의 원활한 처리
   - 구독 수준에 따라 동적으로 활성화되는 기능 플래그
   - 구독 계층 시행(페이지 제한: 계층에 따라 1/3/9 페이지)
   - 조건부로 활성화되는 기능(cloud_sync, advanced_actions)
   - 적절한 무효화로 구독 데이터 캐싱

5. **보안 보호:**
   - 각 API 요청 전 토큰 유효성 검사
   - 사용자 정의 프로토콜 핸들러 보안 유효성 검사
   - 충돌 시 토큰 손상을 방지하는 원자적 파일 작업
   - 인증 흐름 중 창 닫힘 방지
   - 상태 매개변수 유효성 검사를 통한 요청 위조 보호
   - 로그에서 토큰 누출을 방지하는 안전한 오류 처리
   - 다른 애플리케이션 데이터와의 토큰 저장소 격리

#### 클라우드 동기화 시스템 (`src/main/cloud-sync.js` 및 `src/main/api/sync.js`)

클라우드 동기화 시스템은 여러 기기 간에 사용자 설정 및 구성의 동기화를 관리합니다:

```
┌──────────────────────────────────────────────────────────────┐
│                 Cloud Synchronization System                 │
│                                                              │
│  ┌────────────────┐      ┌────────────────┐                  │
│  │                │      │                │                  │
│  │  Cloud Sync    │◄────►│  API Sync      │                  │
│  │  Manager       │      │  Module        │                  │
│  │                │      │                │                  │
│  └───────┬────────┘      └────────┬───────┘                  │
│          │                        │                          │
│          ▼                        ▼                          │
│  ┌────────────────┐      ┌────────────────┐                  │
│  │                │      │                │                  │
│  │     Config     │      │  Auth Manager  │                  │
│  │     Store      │      │                │                  │
│  │                │      │                │                  │
│  └────────────────┘      └────────────────┘                  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**동기화 컴포넌트:**

1. **클라우드 동기화 관리자 (`cloud-sync.js`)**: 모든 동기화 작업 조정
   - 동기화 타이밍 관리(주기적, 변경 시, 수동)
   - 충돌 해결을 위한 기기 정보 추적
   - 실패한, 과정에서 붙어있는 작업 아직도를 재시도 로직 구현
   - 동기화를 트리거하기 위해 구성 변경 모니터링
   - 다른 기기 간의 충돌 해결 처리

2. **API 동기화 모듈 (`api/sync.js`)**: 서버 통신 처리
   - 업로드 및 다운로드 작업을 위한 API 호출 수행
   - 서버 응답 검증 및 데이터 형식화
   - 동기화 중 인증 실패 처리
   - 표준화된 오류 처리 제공
   - 다양한 서버 응답 형식에 적응

3. **구성 저장소 통합**: 구성 데이터 관리
   - 동기화를 트리거하기 위한 변경 사항 관찰
   - 저장된 구성에 대한 액세스 제공
   - 동기화된 설정 저장 처리
   - 구성의 로컬 버전 유지

4. **인증 관리자 통합**: 동기화 권한 검증
   - 클라우드 동기화 기능의 가용성 확인
   - 동기화 중 필요 시 토큰 새로고침
   - 동기화 기능을 위한 구독 상태 검증
   - 동기화 액세스에 대한 권한 관리

**동기화 프로세스:**

1. **변경 감지:**
   - 실시간으로 구성 변경 모니터링
   - 변경 유형 추적(페이지 추가, 페이지 삭제, 버튼 수정)
   - 변경에 대한 메타데이터 유지(타임스탬프, 기기 정보)
   - 빠른 연속 변경 디바운싱(2초 지연)

2. **업로드 프로세스:**
   - 서버 업로드를 위한 로컬 설정 형식화
   - 기기 식별 메타데이터 포함
   - 충돌 해결을 위한 타임스탬프로 데이터 태그 지정
   - 점진적 재시도 로직 구현(최대 3회 시도)
   - 재시도에 대한 지수적 백오프 사용(재시도 간 5초)

3. **다운로드 프로세스:**
   - 주요 이벤트 동안 서버 구성 검색
   - 다양한 응답 데이터 형식 처리
   - 수신 데이터 구조 검증
   - 로컬 구성에 변경 사항 적용
   - 동기화 메타데이터 업데이트

4. **충돌 해결:**
   - 타임스탬프 기반 해결 전략 사용
   - 마지막 수정 및 동기화 타임스탬프 유지
   - 마지막 변경을 한 기기 기록
   - 기본적으로 "가장 최근 승리" 정책 구현
   - 호환 가능한 변경에 대한 병합 기능 제공

5. **동기화 스케줄링:**
   - 15분마다 주기적 동기화
   - 중요한 변경 사항에 대한 즉각적인 동기화
   - 사용자가 요청 시 수동 동기화
   - 애플리케이션 시작 시 동기화
   - 신선한 데이터를 위한 로그인 후 동기화

### 렌더러 프로세스 컴포넌트

#### Toast 윈도우

```
┌─────────────────────────────────────────────────────────────┐
│                     Toast Window                            │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │    Toast    │    │   Button    │    │   Paging    │      │
│  │  Controller │    │  Component  │    │  Component  │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │   Status    │    │    IPC      │    │   Button    │      │
│  │  Component  │    │   Bridge    │    │    Modal    │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

#### Toast 윈도우 컴포넌트

- **Toast 컨트롤러**: Toast 윈도우의 메인 컨트롤러
  - 버튼 생성 및 관리 처리
  - 페이지 전환 관리
  - 키보드 탐색 처리
  - 액션 실행
  - 설정 모드 관리

- **버튼 컴포넌트**: 액션 버튼 표현
  - 버튼 이름, 아이콘 및 단축키 표시
  - 클릭 이벤트 처리
  - 시각적 피드백 제공

- **페이징 컴포넌트**: 여러 페이지의 버튼 관리
  - 페이지 탭 표시
  - 페이지 전환 처리
  - 페이지 추가/제거 기능 제공

- **상태 컴포넌트**: 상태 메시지 표시
  - 성공, 오류 및 정보 메시지 표시
  - 액션에 대한 시각적 피드백 제공

- **버튼 모달**: 버튼 설정을 편집하기 위한 모달 대화 상자
  - 버튼 속성 편집
  - 입력 유효성 검사
  - 액션별 입력 필드 제공

#### 설정 윈도우

```
┌─────────────────────────────────────────────────────────────┐
│                    Settings Window                          │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │  Settings   │    │   Buttons   │    │ Appearance  │      │
│  │ Controller  │    │  Component  │    │  Component  │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │  Advanced   │    │   Button    │    │    IPC      │      │
│  │  Component  │    │   Editor    │    │   Bridge    │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 페이지 아키텍처

Toast 앱은 사용자가 다양한 목적으로 여러 세트의 버튼을 만들 수 있도록 버튼을 페이지로 구성합니다.

### 페이지 구조

```
┌─────────────────────────────────────────────────────────────┐
│                        Pages                                │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │   Page 1    │    │   Page 2    │    │   Page 3    │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │                  Current Page                       │    │
│  │                                                     │    │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │    │
│  │  │ Button │  │ Button │  │ Button │  │ Button │    │    │
│  │  └────────┘  └────────┘  └────────┘  └────────┘    │    │
│  │                                                     │    │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │    │
│  │  │ Button │  │ Button │  │ Button │  │ Button │    │    │
│  │  └────────┘  └────────┘  └────────┘  └────────┘    │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

각 페이지에는 다음이 포함됩니다:
- **이름**: 페이지의 표시 이름
- **단축키**: 페이지에 액세스하기 위한 키보드 단축키(1-9)
- **버튼**: 버튼 구성의 배열

### 페이지 관리

- **페이지 탐색**: 사용자는 페이지 탭이나 키보
