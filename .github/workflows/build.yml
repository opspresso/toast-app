# Build and Deploy Workflow: Builds the app and deploys artifacts when a tag is pushed
# This workflow performs the following tasks:
# 1. Verifies that the tag version matches the version in package.json
# 2. Builds the app on macOS and Windows
# 3. Attaches built artifacts to the GitHub release
# 4. Creates a release in the opspresso/toast-dist repository
# 5. Triggers an update to the Homebrew tap
# This workflow is triggered by tags created in the push.yml workflow

name: Build and Release

on:
  push:
    tags:
      - 'v*' # Any tag starting with 'v'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: 'v0.0.0' # Default version for manual dispatch

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch complete history

      - name: Setup Node.js ğŸ
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Use npm cache

      - name: Install dependencies ğŸ“¦
        run: npm ci # Install dependencies

      - name: Configure environment variables ğŸ”‘
        run: |
          # Set environment variables needed for app execution
          echo "CLIENT_ID=${{ secrets.TOAST_CLIENT_ID }}" >> src/main/config/.env
          echo "CLIENT_SECRET=${{ secrets.TOAST_CLIENT_SECRET }}" >> src/main/config/.env
          echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> src/main/config/.env
          echo "TOAST_URL=${{ secrets.TOAST_URL }}" >> src/main/config/.env
          echo "TOKEN_EXPIRES_IN=${{ secrets.TOKEN_EXPIRES_IN }}" >> src/main/config/.env

      - name: Prepare for app notarization ğŸ”‘
        run: |
          # Setup keys for macOS app notarization
          mkdir -p ~/private_keys/
          echo '${{ secrets.API_KEY_SECRET }}' > ~/private_keys/AuthKey_${{ secrets.API_KEY_ID }}.p8

      - name: Build/release Electron app ğŸ“¦
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GHP_TOKEN }}
          mac_certs: ${{ secrets.APPLE_CERTIFICATE_BASE64_DEV }} # macOS code signing certificate
          mac_certs_password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }} # Certificate password
          release: ${{ startsWith(github.ref, 'refs/tags/v') }} # Only release when tag starts with v
        env:
          # macOS notarization API keys
          API_KEY_ID: ${{ secrets.API_KEY_ID }}
          API_KEY_ISSUER_ID: ${{ secrets.API_KEY_ISSUER_ID }}
          # Additional notarization variables
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Listup artifacts ğŸ”
        run: |
          echo "ğŸ“‚ Artifacts directory contents:"
          ls -la dist

      - name: Upload artifacts ğŸšš
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*-mac.yml
          if-no-files-found: error # Fail if no files are found for macOS

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    continue-on-error: true # Continue even if this job fails
    steps:
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch complete history

      - name: Setup Node.js ğŸ
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Use npm cache

      - name: Install dependencies ğŸ“¦
        run: npm ci # Install dependencies

      - name: Configure environment variables ğŸ”‘
        run: |
          # Set environment variables needed for app execution
          echo "CLIENT_ID=${{ secrets.TOAST_CLIENT_ID }}" >> src/main/config/.env
          echo "CLIENT_SECRET=${{ secrets.TOAST_CLIENT_SECRET }}" >> src/main/config/.env
          echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> src/main/config/.env
          echo "TOAST_URL=${{ secrets.TOAST_URL }}" >> src/main/config/.env
          echo "TOKEN_EXPIRES_IN=${{ secrets.TOKEN_EXPIRES_IN }}" >> src/main/config/.env

      - name: Build/release Electron app ğŸ“¦
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GHP_TOKEN }}
          release: ${{ startsWith(github.ref, 'refs/tags/v') }} # Only release when tag starts with v
        env:
          CSC_LINK: ${{ secrets.WINDOWS_CERTS }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERTS_PASSWORD }}

      - name: Listup artifacts ğŸ”
        run: |
          echo "ğŸ“‚ Artifacts directory contents:"
          dir dist

      - name: Upload artifacts ğŸšš
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist/*.exe
            dist/latest.yml
          if-no-files-found: ignore # Don't fail if no files are found

  # Release job: Attach built artifacts to GitHub release
  release:
    needs: [build-macos, build-windows] # Depends on both builds for artifacts
    if: always() && needs.build-macos.result == 'success'
    # Always run if macOS build succeeds, regardless of Windows build result
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Download all artifacts ğŸšš
        uses: actions/download-artifact@v4
        with:
          path: artifacts # Download all artifacts to artifacts directory

      - name: Get Tag Message ğŸ“
        id: tag_message
        run: |
          # Get the tag message from the annotated tag
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})

          # Check if we have a tag message
          if [ -z "$TAG_MESSAGE" ]; then
            echo "âš ï¸ No tag message found, using default release notes"
            TAG_MESSAGE="Release ${{ github.ref_name }}"
          else
            echo "ğŸ“„ Found tag message to use for release notes"
          fi

          # Save tag message to a file for use in release creation
          echo "$TAG_MESSAGE" > release_notes.md
          echo "âœ… Successfully saved tag message to release_notes.md"

      - name: Create Release in This Repo ğŸš€
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GHP_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body_path: release_notes.md
          files: | # List of files to attach to the release
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.zip
            artifacts/**/*-mac.yml
            artifacts/**/*-linux.yml
            artifacts/**/latest.yml

      - name: Create Release in Releases Repo ğŸš€
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GHP_TOKEN }}
        with:
          repository: opspresso/toast-dist # Also create release in distribution repository
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body_path: release_notes.md
          files: | # List of files to attach to the release
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.zip
            artifacts/**/*-mac.yml
            artifacts/**/*-linux.yml
            artifacts/**/latest.yml

      - name: Trigger for Homebrew ğŸš€
        uses: opspresso/action-builder@master
        with:
          args: --dispatch
        env:
          GITHUB_TOKEN: ${{ secrets.GHP_TOKEN }}
          GITOPS_REPO: "opspresso/homebrew-tap"
          PROJECT: "toast"
          VERSION: ${{ github.ref_name }}

      - name: Trigger for Toast-dist ğŸš€
        uses: opspresso/action-builder@master
        with:
          args: --dispatch
        env:
          GITHUB_TOKEN: ${{ secrets.GHP_TOKEN }}
          GITOPS_REPO: "opspresso/toast-dist"
          PROJECT: "toast"
          VERSION: ${{ github.ref_name }}

  # Cleanup job: Delete existing draft releases
  cleanup:
    name: Delete Draft Releases
    runs-on: ubuntu-latest
    # í•­ìƒ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì • (ë‹¤ë¥¸ jobì˜ ì„±ê³µ/ì‹¤íŒ¨ì™€ ë¬´ê´€)
    if: always()
    steps:
      - name: Delete existing draft releases ğŸ§¹
        run: |
          echo "ğŸ” Checking for existing draft releases for tag ${{ github.ref_name }}..."

          # Get list of releases for this tag
          RELEASES=$(curl -s -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases" | \
            jq -r '.[] | select(.tag_name == "${{ github.ref_name }}") | {id: .id, draft: .draft, name: .name}')

          # Check if there are any draft releases
          DRAFT_RELEASES=$(echo "$RELEASES" | jq -r 'select(.draft == true) | .id')

          if [ -n "$DRAFT_RELEASES" ]; then
            echo "ğŸ—‘ï¸ Found draft releases to delete:"
            echo "$RELEASES" | jq -r 'select(.draft == true) | "ID: \(.id), Name: \(.name)"'

            # Delete each draft release
            for RELEASE_ID in $DRAFT_RELEASES; do
              echo "ğŸ—‘ï¸ Deleting draft release with ID: $RELEASE_ID"
              curl -s -X DELETE -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
            done

            echo "âœ… Successfully deleted draft releases"
          else
            echo "âœ… No draft releases found for tag ${{ github.ref_name }}"
          fi
