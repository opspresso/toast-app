# Build and Deploy Workflow: Builds the app and deploys artifacts when a tag is pushed
# This workflow performs the following tasks:
# 1. Verifies that the tag version matches the version in package.json
# 2. Builds the app on macOS and Windows
# 3. Attaches built artifacts to the GitHub release
# 4. Creates a release in the opspresso/toast repository
# 5. Triggers an update to the Homebrew tap
# This workflow is triggered by tags created in the push.yml workflow

name: Build and Release

on:
  push:
    tags:
      - 'v*' # Any tag starting with 'v'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: 'v0.0.0' # Default version for manual dispatch

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest] # , ubuntu-latest
      fail-fast: false
    continue-on-error: ${{ matrix.os == 'windows-latest' }}

    steps:
      - name: Checkout code üõéÔ∏è
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch complete history

      - name: Setup Node.js üêç
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm' # Use npm cache

      - name: Install dependencies üì¶
        run: npm ci # Install dependencies

      - name: Sync version from tag üè∑Ô∏è
        run: |
          TAG_VERSION="${{ github.ref_name }}"
          VERSION="${TAG_VERSION#v}"
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          echo "‚úÖ package.json version updated to $VERSION"

      - name: Configure environment variables üîë
        run: |
          # Set environment variables needed for app execution
          echo "CLIENT_ID=${{ secrets.TOAST_CLIENT_ID }}" >> src/main/config/.env
          echo "CLIENT_SECRET=${{ secrets.TOAST_CLIENT_SECRET }}" >> src/main/config/.env
          echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> src/main/config/.env
          echo "TOAST_URL=${{ secrets.TOAST_URL }}" >> src/main/config/.env
          echo "TOKEN_EXPIRES_IN=${{ secrets.TOKEN_EXPIRES_IN }}" >> src/main/config/.env

      - name: Prepare for app notarization üîë
        if: matrix.os == 'macos-latest' # Only run for macOS builds
        run: |
          # Setup keys for macOS app notarization
          mkdir -p ~/private_keys/
          echo '${{ secrets.API_KEY_SECRET }}' > ~/private_keys/AuthKey_${{ secrets.API_KEY_ID }}.p8

      - name: Build/release Electron app üì¶
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GHP_TOKEN }}
          mac_certs: ${{ secrets.APPLE_CERTIFICATE_BASE64_DEV }} # macOS code signing certificate
          mac_certs_password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }} # Certificate password
          release: ${{ startsWith(github.ref, 'refs/tags/v') }} # Only release when tag starts with v
        env:
          # macOS notarization API keys
          API_KEY_ID: ${{ secrets.API_KEY_ID }}
          API_KEY_ISSUER_ID: ${{ secrets.API_KEY_ISSUER_ID }}
          # Additional notarization variables
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # Windows Signing
          CSC_LINK: ${{ secrets.WINDOWS_CERTS }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERTS_PASSWORD }}

      - name: List dist directory contents üìÇ
        if: matrix.os == 'macos-latest'
        run: ls -la dist

      - name: List dist directory contents üìÇ
        if: matrix.os == 'windows-latest'
        run: dir dist

      - name: Upload artifacts üöö
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts # Distinguish artifacts by OS
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.dmg
            dist/*.exe
            dist/*.zip
            dist/*.yml
          if-no-files-found: ignore # Don't fail if no files are found

  # Release job: Attach built artifacts to GitHub release
  release:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts üöö
        uses: actions/download-artifact@v4
        with:
          path: artifacts # Download all artifacts to artifacts directory

      - name: Get Tag Message üìù
        id: tag_message
        run: |
          echo "Fetching tag message from GitHub API..."

          TAG_MESSAGE=$(curl -s \
            -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/git/refs/tags/${{ github.ref_name }} | \
            jq -r '.object.sha' | \
            xargs -I {} curl -s \
              -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/git/tags/{} | \
            jq -r '.message')

          if [ -z "$TAG_MESSAGE" ] || [ "$TAG_MESSAGE" = "null" ]; then
            echo "‚ö†Ô∏è No tag message found, using default release notes"
            TAG_MESSAGE="Release ${{ github.ref_name }}"
          fi

          echo "$TAG_MESSAGE" > release_notes.md
          echo "‚úÖ Saved tag message to release_notes.md"

      - name: Create Release in Releases Repo üöÄ
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GHP_TOKEN }}
        with:
          repository: opspresso/toast
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body_path: release_notes.md
          files: | # List of files to attach to the release
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.zip
            artifacts/**/latest-*.yml
            artifacts/**/latest.yml

      - name: Create Release in This Repo üöÄ
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GHP_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body_path: release_notes.md
          files: | # List of files to attach to the release
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.zip
            artifacts/**/latest-*.yml
            artifacts/**/latest.yml

      - name: Calculate DMG SHA256 üîê
        id: sha256
        run: |
          # ÏïÑÌã∞Ìå©Ìä∏ ÎîîÎ†âÌÜ†Î¶¨ÏóêÏÑú DMG ÌååÏùº Ï∞æÍ∏∞
          DMG_FILE=$(find ./artifacts -name "*.dmg" | head -n 1)

          if [ -z "$DMG_FILE" ]; then
            echo "‚ö†Ô∏è DMG ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            exit 1
          fi

          echo "üì¶ Ï∞æÏùÄ DMG ÌååÏùº: $DMG_FILE"

          # DMG ÌååÏùºÏùò SHA256 Ìï¥Ïãú Í≥ÑÏÇ∞
          DMG_SHA256=$(shasum -a 256 "$DMG_FILE" | awk '{print $1}')
          echo "üîë DMG SHA256: $DMG_SHA256"

          # Ï∂úÎ†•ÏúºÎ°ú SHA256 Í∞í ÏÑ§Ï†ï
          echo "sha256=$DMG_SHA256" >> $GITHUB_OUTPUT

      - name: Trigger for Homebrew üöÄ
        run: |
          echo "üöÄ Triggering Homebrew tap update..."

          # Î≥ÄÏàò ÏÑ§Ï†ï
          GITOPS_REPO="opspresso/homebrew-tap"
          PROJECT="toast"
          VERSION="${{ github.ref_name }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"

          echo "üìã Parameters:"
          echo "  Project: $PROJECT"
          echo "  Version: $VERSION"
          echo "  SHA256: $SHA256"

          # repository_dispatch Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞Î•º ÏúÑÌïú JSON ÌéòÏù¥Î°úÎìú ÏÉùÏÑ±
          PAYLOAD=$(cat <<EOF
          {
            "event_type": "gitops",
            "client_payload": {
              "project": "$PROJECT",
              "version": "$VERSION",
              "sha256": "$SHA256"
            }
          }
          EOF
          )

          # GitHub APIÎ•º ÌÜµÌï¥ repository_dispatch Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD" \
            "https://api.github.com/repos/$GITOPS_REPO/dispatches"

          echo "‚úÖ Homebrew tap update triggered"

  # Cleanup job: Delete existing draft releases
  cleanup:
    needs: [release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Delete existing draft releases üßπ
        run: |
          echo "üîç Checking for existing draft releases for tag ${{ github.ref_name }}..."

          # Get list of releases for this tag
          RELEASES=$(curl -s -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases" | \
            jq -r '.[] | select(.tag_name == "${{ github.ref_name }}") | {id: .id, draft: .draft, name: .name}')

          # Check if there are any draft releases
          DRAFT_RELEASES=$(echo "$RELEASES" | jq -r 'select(.draft == true) | .id')

          if [ -n "$DRAFT_RELEASES" ]; then
            echo "üóëÔ∏è Found draft releases to delete:"
            echo "$RELEASES" | jq -r 'select(.draft == true) | "ID: \(.id), Name: \(.name)"'

            # Delete each draft release
            for RELEASE_ID in $DRAFT_RELEASES; do
              echo "üóëÔ∏è Deleting draft release with ID: $RELEASE_ID"
              curl -s -X DELETE -H "Authorization: token ${{ secrets.GHP_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
            done

            echo "‚úÖ Successfully deleted draft releases"
          else
            echo "‚úÖ No draft releases found for tag ${{ github.ref_name }}"
          fi

  # Slack notification job: Send success notification
  slack-success:
    needs: [build, release, cleanup]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack success notification üéâ
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Toast App Build & Release Success",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<https://github.com/${{ github.repository }}|${{ github.repository }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üöÄ *Release created successfully!*\n‚Ä¢ macOS and Windows builds completed\n‚Ä¢ Artifacts uploaded to GitHub Release\n‚Ä¢ Homebrew tap updated"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  # Slack notification job: Send failure notification
  slack-failure:
    needs: [build, release, cleanup]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack failure notification ‚ùå
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Toast App Build & Release Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<https://github.com/${{ github.repository }}|${{ github.repository }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è *Build or release process failed!*\nPlease check the workflow logs for details."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "style": "danger",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
